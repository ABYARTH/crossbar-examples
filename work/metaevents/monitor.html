<!DOCTYPE html>
<html>
   <body>
      <h1>Hello WAMP</h1>
      <p>Open JavaScript console to watch output.</p>

      <h2>Sessions</h2>
      <p>
         <button onclick="list_sessions()">List Sessions</button>
         <button onclick="count_sessions()">Count Sessions</button>
      </p>

      <h2>Topic 1</h2>
      <p>
         <button onclick="topic1_get_subscription()">Get Subscription</button>
         <button onclick="topic1_list_subscribers()">List Subscribers</button>
         <button onclick="topic1_count_subscribers()">Count Subscribers</button>
         <button onclick="topic1_match_subscribers()">Match Subscribers</button>
      </p>

      <h2>Procedure 1</h2>
      <p>
         <button onclick="procedure1_get_registration()">Get Registration</button>
         <button onclick="procedure1_list_callees()">List Callees</button>
         <button onclick="procedure1_count_callees()">Count Callees</button>
      </p>

      <h2>Registrations</h2>
      <p>
         <button onclick="get_registrations()">Get Registrations</button>
      </p>

      <script>AUTOBAHN_DEBUG = false;</script>
<!--
      <script src="http://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>
-->
      <script src="autobahn.min.js"></script>

      <script>
         var wsuri = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" + document.location.host + "/ws";

         var connection = new autobahn.Connection({
            url: wsuri,
            realm: "realm1"
         });

         var session = null;

         //
         // Meta Procedures for Sessions
         //

         // wamp.session.list
         // wamp.session.get
         function list_sessions () {
            if (session) {
               session.call("wamp.session.list").then(
                  function (sessions) {
                     console.log("Current session IDs on realm", sessions);
                     for (var i = 0; i < sessions.length; ++i) {
                        session.call("wamp.session.get", [sessions[i]]).then(
                           function (session_details) {
                              console.log(session_details);
                           },
                           function (err) {
                              console.log(err);
                           }
                        );
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve subscription for topic", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         // wamp.session.count
         function count_sessions () {
            if (session) {
               session.call("wamp.session.count").then(
                  function (session_count) {
                     console.log("Current number of sessions joined on the realm: " + session_count);
                  },
                  function (err) {
                     console.log("Could not retrieve number of sessions", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         //
         // Meta Procedures for Registrations
         //

         // procedure1
         //
         var procedure1_uri = "com.example.procedure1";
         var procedure1_options = {};

         // wamp.registration.lookup
         // wamp.registration.get
         function procedure1_get_registration () {
            if (session) {
               session.call("wamp.registration.lookup", [procedure1_uri, procedure1_options]).then(
                  function (registration_id) {
                     if (registration_id) {
                        session.call("wamp.registration.get", [registration_id]).then(
                           function (registration) {
                              console.log("Procedure " + procedure1_uri + " is managed via registration", registration);
                           },
                           function (err) {
                              console.log("Could not retrieve registration", err);
                           }
                        );
                     } else {
                        console.log("No registration for procedure " + procedure1_uri + " currently exists on dealer");
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve registration for procedure", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         // wamp.registration.lookup
         // wamp.registration.list_callees
         function procedure1_list_callees () {
            if (session) {
               session.call("wamp.registration.lookup", [procedure1_uri, procedure1_options]).then(
                  function (registration_id) {
                     if (registration_id) {
                        session.call("wamp.registration.list_callees", [registration_id]).then(
                           function (callees) {
                              console.log("Callees on procedure " + procedure1_uri + " (registration " + registration_id + "):", callees);
                           },
                           function (err) {
                              console.log("Could not retrieve calless on registration", err);
                           }
                        );
                     } else {
                        console.log("No registration for procedure " + procedure1_uri + " currently exists on dealer");
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve registration for procedure", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         // wamp.registration.lookup
         // wamp.registration.count_callees
         function procedure1_count_callees () {
            if (session) {
               session.call("wamp.registration.lookup", [procedure1_uri, procedure1_options]).then(
                  function (registration_id) {
                     if (registration_id) {
                        session.call("wamp.registration.count_callees", [registration_id]).then(
                           function (count) {
                              if (count) {
                                 console.log("" + count + " callees on procedure " + procedure1_uri);
                              } else {
                                 console.log("No callees on procedure " + procedure1_uri);
                              }
                           },
                           function (err) {
                              console.log("Could not retrieve callee count on registration", err);
                           }
                        );
                     } else {
                        console.log("No registration for procedure " + procedure1_uri + " currently exists on dealer");
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve registration for procedure", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         // wamp.registration.list
         // wamp.registration.get
         function get_registrations () {
            if (session) {
               session.call("wamp.registration.list").then(
                  function (registrations) {
                     console.log("Current registrations", registrations);
                     var match_policies = ['exact', 'prefix', 'wildcard'];

                     // for each match policy ..
                     for (var j = 0; j < match_policies.length; ++j) {
                        (function (l) {
                           var match_policy = match_policies[l];

                           // .. get the registrations
                           for (var i = 0; i < registrations[match_policy].length; ++i) {
                              (function (k) {
                                 session.call("wamp.registration.get", [registrations[match_policy][k]]).then(
                                    function (registration) {
                                       console.log("Registration", registration);
                                    },
                                    function (err) {
                                       console.log(err);
                                    }
                                 );
                              })(i);
                           }
                        })(j);
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve registrations", err);
                  }
               );
            } else {
               console.log("not connected");
            }            
         }

         //
         // Meta Procedures for Subscriptions
         //

         // topic1
         //
         var topic1_uri = "com.example.topic1";
         var topic1_options = {};

         // wamp.subscription.lookup
         // wamp.subscription.get
         function topic1_get_subscription () {
            if (session) {
               session.call("wamp.subscription.lookup", [topic1_uri, topic1_options]).then(
                  function (subscription_id) {
                     if (subscription_id) {
                        session.call("wamp.subscription.get", [subscription_id]).then(
                           function (subscription) {
                              console.log("Topic " + topic1_uri + " is managed via subscription", subscription);
                           },
                           function (err) {
                              console.log("Could not retrieve subscription", err);
                           }
                        );
                     } else {
                        console.log("No subscription for topic " + topic1_uri + " currently exists on broker");
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve subscription for topic", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         // wamp.subscription.lookup
         // wamp.subscription.list_subscribers
         function topic1_list_subscribers () {
            if (session) {
               session.call("wamp.subscription.lookup", [topic1_uri, topic1_options]).then(
                  function (subscription_id) {
                     if (subscription_id) {
                        session.call("wamp.subscription.list_subscribers", [subscription_id]).then(
                           function (subscribers) {
                              console.log("Subscribers on topic " + topic1_uri + " (subscription " + subscription_id + "):", subscribers);
                           },
                           function (err) {
                              console.log("Could not retrieve subscribers on subscription", err);
                           }
                        );
                     } else {
                        console.log("No subscription for topic " + topic1_uri + " currently exists on broker");
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve subscription for topic", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         // wamp.subscription.lookup
         // wamp.subscription.count_subscribers
         function topic1_count_subscribers () {
            if (session) {
               session.call("wamp.subscription.lookup", [topic1_uri, topic1_options]).then(
                  function (subscription) {
                     if (subscription_id) {
                        session.call("wamp.subscription.count_subscribers", [subscription_id]).then(
                           function (count) {
                              if (count) {
                                 console.log("" + count + " subscribers on topic " + topic1_uri);
                              } else {
                                 console.log("No subscribers on topic " + topic1_uri);
                              }
                           },
                           function (err) {
                              console.log("Could not retrieve subscriber count on subscription", err);
                           }
                        );
                     } else {
                        console.log("No subscription for topic " + topic1 + " currently exists on broker");
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve subscription for topic", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         // wamp.subscription.match
         // wamp.subscription.list_subscribers
         function topic1_match_subscribers () {
            if (session) {
               session.call("wamp.subscription.lookup", [topic1_uri, topic1_options]).then(
                  function (subscription_id) {
                     if (subscription_id) {
                        session.call("wamp.subscription.count_subscribers", [subscription_id]).then(
                           function (count) {
                              if (count) {
                                 console.log("" + count + " subscribers on topic " + topic1_uri);
                              } else {
                                 console.log("No subscribers on topic " + topic1_uri);
                              }
                           },
                           function (err) {
                              console.log("Could not retrieve subscriber count on subscription", err);
                           }
                        );
                     } else {
                        console.log("No subscription for topic " + topic1 + " currently exists on broker");
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve subscription for topic", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         // wamp.subscription.list
         // wamp.subscription.get
         function get_subscriptions () {
            if (session) {
               session.call("wamp.subscription.list").then(
                  function (subscriptions) {
                     console.log("Current subscription", subscriptions);
                     var match_policies = ['exact', 'prefix', 'wildcard'];

                     // for each match policy ..
                     for (var j = 0; j < match_policies.length; ++j) {
                        (function (l) {
                           var match_policy = match_policies[l];

                           // .. get the registrations
                           for (var i = 0; i < subscriptions[match_policy].length; ++i) {
                              (function (k) {
                                 session.call("wamp.subscription.get", [subscriptions[match_policy][k]]).then(
                                    function (registration) {
                                       console.log("Subscription", subscription);
                                    },
                                    function (err) {
                                       console.log(err);
                                    }
                                 );
                              })(i);
                           }
                        })(j);
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve subscriptions", err);
                  }
               );
            } else {
               console.log("not connected");
            }            
         }

         // connection
         //
         connection.onopen = function (new_session, details) {

            session = new_session;

            console.log("Connected with session ID " + session.id, details);

            var meta_topics = [
               // Meta Events for Sessions
               "wamp.session.on_join",
               "wamp.session.on_leave",

               // Meta Events for Subscriptions
               "wamp.subscription.on_create",
               "wamp.subscription.on_subscribe",
               "wamp.subscription.on_unsubscribe",
               "wamp.subscription.on_delete",

               // Meta Events for Registrations
               "wamp.registration.on_create",
               "wamp.registration.on_register",
               "wamp.registration.on_unregister",
               "wamp.registration.on_delete",

               // Meta Events for Schemas
               "wamp.schema.on_define",
               "wamp.schema.on_undefine",
            ];

            // subscribe to all of above WAMP meta events
            for (var i = 0; i < meta_topics.length; ++i) {

               (function subscribe (topic) {

                  function on_meta_event (args, kwargs) {
                     console.log("WAMP meta event " + topic + " received", args, kwargs);
                  }

                  session.subscribe(topic, on_meta_event).then(
                     function (sub) {
                        console.log('Subscribed to meta topic ' + topic);
                     },
                     function (err) {
                        console.log('Failed to subscribe to meta topic ' + topic, err);
                     }
                  );

               })(meta_topics[i]);
            }
         };

         connection.onclose = function (reason, details) {
            console.log("Connection lost: " + reason);
         }

         connection.open();
      </script>
   </body>
</html>
