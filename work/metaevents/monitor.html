<!DOCTYPE html>
<html>
   <body>
      <h1>Hello WAMP</h1>
      <p>Open JavaScript console to watch output.</p>

      <h2>Sessions</h2>
      <p>
         <button onclick="list_sessions()">List Sessions</button>
      </p>

      <h2>Topic 1</h2>
      <p>
         <button onclick="topic1_get_subscription()">Get Subscription</button>
         <button onclick="topic1_list_subscribers()">List Subscribers</button>
         <button onclick="topic1_count_subscribers()">Count Subscribers</button>
      </p>

      <h2>Procedure 1</h2>
      <p>
         <button onclick="procedure1_get_registration()">Get Registration</button>
         <button onclick="procedure1_list_callees()">List Callees</button>
         <button onclick="procedure1_count_callees()">Count Callees</button>
      </p>

      <script>AUTOBAHN_DEBUG = false;</script>
<!--
      <script src="http://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>
-->
      <script src="autobahn.min.js"></script>

      <script>
         var wsuri = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" + document.location.host + "/ws";

         var connection = new autobahn.Connection({
            url: wsuri,
            realm: "realm1"
         });

         var session = null;

         function list_sessions () {
            if (session) {
               session.call("wamp.session.list").then(
                  function (sessions) {
                     console.log("Current session IDs on realm", sessions);
                     for (var i = 0; i < sessions.length; ++i) {
                        session.call("wamp.session.get", [sessions[i]]).then(
                           function (session_details) {
                              console.log(session_details);
                           },
                           function (err) {
                              console.log(err);
                           }
                        );
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve subscription for topic", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         // procedure1
         //
         var procedure1_uri = "com.example.procedure1";
         var procedure1_options = {};

         function procedure1_get_registration () {
            if (session) {
               session.call("wamp.dealer.registration.get", [procedure1_uri, procedure1_options]).then(
                  function (registration) {
                     if (registration) {
                        console.log("Procedure " + procedure1_uri + " is managed via registration", registration);
                     } else {
                        console.log("No registration for procedure " + procedure1_uri + " currently exists on dealer");
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve registration for procedure", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         function procedure1_list_callees () {
            if (session) {
               session.call("wamp.dealer.registration.get", [procedure1_uri, procedure1_options]).then(
                  function (registration) {
                     if (registration) {
                        session.call("wamp.dealer.callee.list", [registration.id]).then(
                           function (callees) {
                              console.log("Callees on procedure " + procedure1_uri + " (registration " + registration.id + "):", callees);
                           },
                           function (err) {
                              console.log("Could not retrieve calless on registration", err);
                           }
                        );
                     } else {
                        console.log("No registration for procedure " + procedure1_uri + " currently exists on dealer");
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve registration for procedure", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         function procedure1_count_callees () {
            if (session) {
               session.call("wamp.dealer.registration.get", [procedure1_uri, procedure1_options]).then(
                  function (registration) {
                     if (registration) {
                        session.call("wamp.dealer.callee.count", [registration.id]).then(
                           function (count) {
                              if (count) {
                                 console.log("" + count + " callees on procedure " + procedure1_uri);
                              } else {
                                 console.log("No callees on procedure " + procedure1_uri);
                              }
                           },
                           function (err) {
                              console.log("Could not retrieve callee count on registration", err);
                           }
                        );
                     } else {
                        console.log("No registration for procedure " + procedure1_uri + " currently exists on dealer");
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve registration for procedure", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         // topic1
         //
         var topic1_uri = "com.example.topic1";
         var topic1_options = {};

         function topic1_get_subscription () {
            if (session) {
               session.call("wamp.broker.subscription.get", [topic1_uri, topic1_options]).then(
                  function (subscription) {
                     if (subscription) {
                        console.log("Topic " + topic1_uri + " is managed via subscription", subscription);
                     } else {
                        console.log("No subscription for topic " + topic1_uri + " currently exists on broker");
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve subscription for topic", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         function topic1_list_subscribers () {
            if (session) {
               session.call("wamp.broker.subscription.get", [topic1_uri, topic1_options]).then(
                  function (subscription) {
                     if (subscription) {
                        session.call("wamp.broker.subscriber.list", [subscription.id]).then(
                           function (subscribers) {
                              console.log("Subscribers on topic " + topic1_uri + " (subscription " + subscription.id + "):", subscribers);
                           },
                           function (err) {
                              console.log("Could not retrieve subscribers on subscription", err);
                           }
                        );
                     } else {
                        console.log("No subscription for topic " + topic1_uri + " currently exists on broker");
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve subscription for topic", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         function topic1_count_subscribers () {
            if (session) {
               session.call("wamp.broker.subscription.get", [topic1_uri, topic1_options]).then(
                  function (subscription) {
                     if (subscription) {
                        session.call("wamp.broker.subscriber.count", [subscription.id]).then(
                           function (count) {
                              if (count) {
                                 console.log("" + count + " subscribers on topic " + topic1_uri);
                              } else {
                                 console.log("No subscribers on topic " + topic1_uri);
                              }
                           },
                           function (err) {
                              console.log("Could not retrieve subscriber count on subscription", err);
                           }
                        );
                     } else {
                        console.log("No subscription for topic " + topic1 + " currently exists on broker");
                     }
                  },
                  function (err) {
                     console.log("Could not retrieve subscription for topic", err);
                  }
               );
            } else {
               console.log("not connected");
            }
         }

         // connection
         //
         connection.onopen = function (new_session, details) {

            session = new_session;

            console.log("Connected with session ID " + session.id);

            var meta_topics = [
               // WAMP Session meta events
               "wamp.session.on_join",
               "wamp.session.on_leave",

               // WAMP PubSub meta events
               "wamp.topic.on_first_subscribe",
               "wamp.topic.on_subscribe",
               "wamp.topic.on_unsubscribe",
               "wamp.topic.on_last_unsubscribe",

               // WAMP RPC meta events
               "wamp.procedure.on_first_register",
               "wamp.procedure.on_register",
               "wamp.procedure.on_unregister",
               "wamp.procedure.on_last_unregister",

               // WAMP reflection
               "wamp.reflect.on_define",
               "wamp.reflect.on_undefine",
            ];

            // subscribe to all of above WAMP meta events
            for (var i = 0; i < meta_topics.length; ++i) {

               (function subscribe (topic) {

                  function on_meta_event (args, kwargs) {
                     console.log("WAMP meta event " + topic + " received", args, kwargs);
                  }

                  session.subscribe(topic, on_meta_event).then(
                     function (sub) {
                        console.log('Subscribed to meta topic ' + topic);
                     },
                     function (err) {
                        console.log('Failed to subscribe to meta topic ' + topic, err);
                     }
                  );

               })(meta_topics[i]);
            }
         };

         connection.onclose = function (reason, details) {
            console.log("Connection lost: " + reason);
         }

         connection.open();
      </script>
   </body>
</html>
