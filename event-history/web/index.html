<html>
   <body>
      <h1>Crossbar.io Event History</h1>
      <p>Open JavaScript console to watch output.</p>
      <script>AUTOBAHN_DEBUG = false;</script>
      <script src="http://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>
      <script>
         var wsuri;
         if (document.location.origin == "file://") {
            wsuri = "ws://127.0.0.1:8080/ws";

         } else {
            wsuri = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" +
                        document.location.host + "/ws";
         }

         var connection = new autobahn.Connection({
            url: wsuri,
            realm: "realm1"
         });

         connection.onopen = function (session, details) {
            console.log("Connected");

            var counter = 0;

            setInterval(function () {
               session.publish('com.example.oncounter', [counter], null, {exclude_me: false});
               //console.log("published to 'oncounter' with counter " + counter);
               counter += 1;
            }, 1000);

            session.subscribe('com.example.oncounter', function (args) {
               console.log('com.example.oncounter', args);
            }).then(
               function (sub) {
                  console.log("subscribed with subscription ID " + sub.id);

                  session.call('wamp.subscription.count_subscribers', [sub.id]).then(
                     function (res) {
                        console.log("currently " + res + " subscribers");
                     },
                     function (err) {
                        console.log(err);
                     }
                  );

                  session.call('wamp.subscription.get_events', [sub.id, 5]).then(
                     function (res) {
                        console.log("got history for " + res.length + " events");
                        for (var i = 0; i < res.length; ++i) {
                           console.log(res[i].args[0]);
                        }
                     },
                     function (err) {
                        console.log(err);
                     }
                  );

               },
               function (err) {
                  console.log("could not subscribe", err);
               }
            );

         };

         connection.onclose = function (reason, details) {
            console.log("Connection lost: " + reason);
         }

         connection.open();
      </script>
   </body>
</html>
