<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <title>Raspberry Pi Camera</title>
</head>
<body>
   <h1>
      Raspberry Pi Camera
   </h1>

   <div class="imageContainer">
      <img id="image" src="burglar.png">
      <div id="imageProgress"></div>
   </div>

   <button id="shutter">Take Photo</button>

   <script src="http://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>
   <script>
      var session = null;
      var image = document.getElementById("image");
      var imageProgress = document.getElementById("imageProgress");

      // the URL of the WAMP Router (Crossbar.io)
      var wsuri;
      if (document.location.origin == "file://") {
         wsuri = "ws://127.0.0.1:8080/ws"; // localhost for development
      } else {
         wsuri = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" +
                     document.location.host + "/ws"; // URL of the Crossbar.io instance this is served from
      }

      // the WAMP connection to the Router
      //
      var connection = new autobahn.Connection({
         url: wsuri, // replace with URL of WAMP router if this doesn't serve the file
         realm: "iot_cookbook"
      });

      var requestPhoto = function () {

         session.call("io.crossbar.examples.pi.camera.take_photo", [], {}, {receive_progress: true}).then(
            function (res) {
               
               // imageProgress.innerHTML = "";

               // console.log("image from node.js component");
               console.log(res);


               // // fails
               // image.src = "data:image/jpg;base64," + res;

               image.src = "data:image/jpg;base64,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";

               var resPlainText = atob(res);
               // console.log("image received", resPlainText); // indicates this is indeed a jpg file
               

            }, 
            function (err) {
               console.log("requestImage failed", err);
               imageProgress.innerHTML = "Error getting image!";
            }, 
            function (progress) {
               console.log("camera", progress.args[0], progress.args[1]);
               var progressText = "";
               switch (progress.args[0]) {
                  case "takePhoto called":
                     imageProgress.innerHTML = "Photo triggered."
                  case "taken":
                     imageProgress.innerHTML = "Photo has been taken."
                     break;
                  case "encoding":
                     imageProgress.innerHTML = "Photo is being encoded."
                     break;
                  case "transmitting":
                     imageProgress.innerHTML = "Photo is being transmitted."
                     break;
                  default:
                     console.log("unknown tranmission state received!");
                     break;
               }
            }
         );
      };

      // fired when connection is established and session attached
      //
      connection.onopen = function (sess, details) {

         session = sess;

         console.log("connected");

         document.getElementById("shutter").addEventListener("click", requestPhoto);
         

      };

      // fired when connection was lost (or could not be established)
      //
      connection.onclose = function (reason, details) {

         console.log("Connection lost: " + reason);

      }

      // now actually open the connection
      //
      connection.open();

   </script>
</body>
</html>